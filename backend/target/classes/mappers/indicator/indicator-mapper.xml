<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.monstersinc.stock101.indicator.model.mapper.IndicatorMapper">

    <!-- 개미 지표 SQL   -->
    <sql id="selectIndividualIndicatorSql">
        SELECT
            stock_id,
             date,
            result,
            strong_sell,
            sell,
            hold,
            buy,
            strong_buy
        FROM individual_indicators
    </sql>

    <!-- 애널리스트 지표 SQL   -->
    <sql id="selectAnalystIndicatorSql">
        SELECT
            stock_id,
            date,
            result,
            strong_sell,
            sell,
            hold,
            buy,
            strong_buy
        FROM analyst_indicators
    </sql>


    <!-- 개미 지표 ResultMap-->
    <resultMap id="individualIndicatorResultMap" type="IndividualIndicator">
        <id     property="stockId"   column="stock_id" />
        <result   property="date"   column="date" />
        <result property="result"  column="result" />
        <result property="strongSell"  column="strong_sell" />
        <result property="sell"  column="sell" />
        <result property="hold"  column="hold" />
        <result property="buy"  column="buy" />
        <result property="strongBuy"  column="strong_buy" />
    </resultMap>

    <!-- 애널리스트 지표 ResultMap-->
    <resultMap id="analystIndicatorResultMap" type="AnalystIndicator">
        <id     property="stockId"   column="stock_id" />
        <result   property="date"   column="date" />
        <result property="result"  column="result" />
        <result property="strongSell"  column="strong_sell" />
        <result property="sell"  column="sell" />
        <result property="hold"  column="hold" />
        <result property="buy"  column="buy" />
        <result property="strongBuy"  column="strong_buy" />
    </resultMap>



    <!-- Stock ID로 최신 개미 지표 조회-->
    <select id="selectIndividualIndicatorByStockId"
            parameterType="long"
            resultMap="individualIndicatorResultMap">
        <include refid="selectIndividualIndicatorSql" />
        <where>
            stock_id = #{stockId}
        </where>
        ORDER BY date DESC
        LIMIT 1
    </select>

    <!-- Stock ID로 최신 애널리스트 지표 조회-->
    <select id="selectAnalystIndicatorByStockId"
            parameterType="long"
            resultMap="analystIndicatorResultMap">
        <include refid="selectAnalystIndicatorSql" />
        <where>
            stock_id = #{stockId}
        </where>
        ORDER BY date DESC
        LIMIT 1
    </select>

    <!-- Stock ID로 최신 뉴스 지표 조회-->

    <resultMap id="newsIndicatorResultMap" type="NewsIndicator">
        <result property="stockId"       column="stock_id"/>
        <result property="stockCode"         column="stock_code"/>
        <result property="negativeCount" column="negative_count"/>
        <result property="neutralCount"          column="neutral_count"/>
        <result property="positiveCount"   column="positive_count"/>
    </resultMap>

    <select id="selectNewsIndicatorByStockId"
            parameterType="long"
            resultMap="newsIndicatorResultMap">
        SELECT
            stock_id,
            stock_code,
            COALESCE(SUM(CASE WHEN `result` = 'NEGATIVE' THEN 1 ELSE 0 END), 0) AS negative_count,
            COALESCE(SUM(CASE WHEN `result` = 'NEUTRAL'  THEN 1 ELSE 0 END), 0) AS neutral_count,
            COALESCE(SUM(CASE WHEN `result` = 'POSITIVE' THEN 1 ELSE 0 END), 0) AS positive_count
        FROM news_indicators
        WHERE stock_id = #{stockId}
          AND `date` BETWEEN DATE_SUB(CURDATE(), INTERVAL 6 DAY) AND CURDATE()
        GROUP BY stock_id, stock_code
    </select>

    <!-- 재무 지표 SQL -->
    <sql id="selectFinancialIndicatorSql">
        SELECT
            financial_id,
            EPS,
            BPS,
            ROE,
            ROA,
            quarter,
            stock_id
        FROM financial_indicators
    </sql>

    <!-- 재무 지표 ResultMap -->
    <resultMap id="financialIndicatorResultMap" type="FinancialIndicator">
        <id     property="financialId" column="financial_id"/>
        <result property="eps"         column="EPS"/>
        <result property="bps"         column="BPS"/>
        <result property="roe"         column="ROE"/>
        <result property="roa"         column="ROA"/>
        <result property="quarter"     column="quarter"/>
        <result property="stockId"     column="stock_id"/>
    </resultMap>

    <!-- Stock ID로 최신 재무 지표 조회 -->
    <select id="selectFinancialIndicatorByStockId"
            parameterType="long"
            resultMap="financialIndicatorResultMap">
        <include refid="selectFinancialIndicatorSql"/>
        <where>
            stock_id = #{stockId}
        </where>
        ORDER BY financial_id DESC
        LIMIT 1
    </select>

</mapper>