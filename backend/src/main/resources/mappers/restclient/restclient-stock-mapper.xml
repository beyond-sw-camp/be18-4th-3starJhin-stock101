<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.monstersinc.stock101.restclient.stock.model.mapper.StockRestClientMapper">
    <!-- getAllStockCodes returns DTO with stockId and stockCode -->
    <select id="getAllStockCodes" resultType="com.monstersinc.stock101.restclient.stock.model.dto.GetStockCodeDto">
        SELECT stock_id AS stockId,
               stock_code AS stockCode
        FROM stocks
    </select>
    <!-- ticker로 조회: 인터페이스의 getStockIdByCode와 매핑되는 쿼리 -->
    <select id="getStockIdByCode" resultType="com.monstersinc.stock101.restclient.stock.model.dto.GetStockCodeDto" parameterType="String">
        SELECT stock_id AS stockId,
               stock_code AS stockCode
        FROM stocks
        WHERE stock_code = #{ticker}
    </select>
    <!-- 존재 여부 확인 -->
    <select id="existsFinance" resultType="boolean" parameterType="long">
        SELECT COUNT(1) > 0
        FROM financial_indicators
        WHERE stock_id = #{stockId}
    </select>

    <!-- INSERT -->
    <insert id="insertFinance" parameterType="com.monstersinc.stock101.restclient.stock.model.dto.StockFinancialInfoResDto">
        INSERT INTO financial_indicators (EPS,BPS,ROE,ROA,quarter,stock_id)
        VALUES (#{eps},#{bps},#{roe},#{roa},#{quarter},#{stockId})
    </insert>

    <!-- UPDATE: interface에서 호출하는 id(updateFinance)로 변경 -->
    <update id="updateFinance" parameterType="com.monstersinc.stock101.restclient.stock.model.dto.StockFinancialInfoResDto">
        UPDATE financial_indicators
        SET EPS = #{eps},
            BPS = #{bps},
            ROE = #{roe},
            ROA = #{roa},
            quarter = #{quarter}
        WHERE stock_id = #{stockId}
    </update>
    <select id="getStockPriceById" resultType="double" parameterType="long">
        SELECT price
        FROM stocks
        WHERE stock_id = #{id}
    </select>
    <!-- stock_prices 테이블에 가격 이력 추가 -->
    <insert id="insertStockPrice" parameterType="com.monstersinc.stock101.restclient.stock.model.dto.StockPriceDto">
        INSERT INTO stock_prices (stock_id, closing_price, date, stock_price_pk)
        VALUES (#{id}, #{close}, #{from}, #{PK})
    </insert>

    <!-- stocks 테이블 업데이트 -->
    <update id="updateStockInfo" parameterType="com.monstersinc.stock101.restclient.stock.model.dto.StockPriceDto">
        UPDATE stocks
        SET price = #{close},
            fluctuation = #{fluctuation}
        WHERE stock_id = #{id}
    </update>

    <insert id="insertNews" parameterType="com.monstersinc.stock101.restclient.stock.model.dto.GetNewsDto">
        INSERT INTO news (news_id, title, content_summary, published_at, link, ticker, result, stock_id, img_url)
        VALUES (#{newsId}, #{title}, #{contentSummary}, #{publishedAt}, #{articleUrl}, #{ticker}, #{result}, #{stockId}, #{image_url})
    </insert>

    <select id="existsNews" resultType="boolean" parameterType="string">
        SELECT COUNT(1) > 0
        FROM news
        WHERE news_id = #{newsId}
    </select>

    <insert id="insertInsight" parameterType="com.monstersinc.stock101.restclient.stock.model.dto.NewsIndicatorDto">
        INSERT INTO news_indicators (Insight_id,result, date, stock_code, news_id, stock_id)
        VALUES (#{insightId}, #{result}, #{date}, #{ticker}, #{newsId}, #{stockId})
    </insert>

</mapper>
